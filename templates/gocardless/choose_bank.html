{% extends "base.html" %}

{% block content %}

<style>
    .country {
        border: 1px solid red;
        border-radius: 4px;
    }

    .country.selected {
        border-color: blue;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: grey;
    }

    .divider {
        width: 70%;
        background-color: gray;
        height: 1px;
        margin-top: 2px;
        margin-bottom: 2px;
        opacity: .75;
    }
</style>
<div class="container">
    <h1 class="mb-4">Choose a bank for GoCardless</h1>

    <div class="tab-content" id="importTabsContent">
        <div class="tab-pane fade show active" id="choose-country" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Choose your country</h5>
                </div>
                <div class="card-body">
                    <p>The following countries are supported by GoCardless. Your choice will determine the available
                        banks on the next page.</p>
                    <div class="row">
                        {% for country in countries %}
                        <!-- <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Note:</strong> Account names should be 150 characters or less.
                            </div> -->
                        <div class="col-sm-2 country p-2 m-2" data-code="{{ country[1] }}"
                            onclick="selectCountry(this)">
                            {{ country[0] }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="choose-bank" role="tabpanel" aria-labelledby="gocardless-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Select your bank</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <i class="fas fa-shield-alt me-2"></i>
                            GoCardless never shares your bank credentials with us. We only receive the transaction data
                            you
                            authorize.
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('gocardless.process_bank') }}">
                        <div style="display: flex; justify-content:center;">
                            <div id="bank-select"
                                style="min-width: 50%; max-width: 80%; max-height: calc(5 * 40px); overflow-y: scroll;">
                            </div>
                        </div>
                        <input type="text" class="form-control bg-dark text-light" id="bank_value" name="bank_value"
                            placeholder="Paste your secret id here" value="CHOOSE_BANK" hidden>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="choose-terms" role="tabpanel" aria-labelledby="gocardless-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Adjust user agreement terms</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="agreement-terms" action="{{ url_for('gocardless.process_bank') }}">
                        <div class="mb-4">
                            <label for="max_historical_days" class="form-label">Enter the amount of days of transaction
                                history to be retrieved</label>
                            <input type="number" class="form-control bg-dark text-light" id="max_historical_days"
                                name="max_historical_days" value="90" min="1" max="90">
                        </div>
                        <div class="mb-4">
                            <label for="access_valid_for_days" class="form-label">Enter the amount of days the access to
                                your data is valid
                            </label>
                            <input type="number" class="form-control bg-dark text-light" id="access_valid_for_days"
                                name="access_valid_for_days" value="90" min="1" max="90">
                        </div>
                        <div>
                            <div style="width:fit-content">
                                <label for="access_scope" class="form-label">Select the scope of the information you
                                    want to
                                    give access to</label>
                                <div style="height: 1px; background-color: grey; opacity: 0.5"></div>
                            </div>
                            <fieldset>
                                <div class="d-flex flex-column mt-2">
                                    <div>
                                        <input type="checkbox" id="balances" name="access_scope" value="balances">
                                        <label for="balances" class="form-label">Account balances</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="details" name="access_scope" value="details">
                                        <label for="details" class="form-label">Account details</label>
                                    </div>
                                    <div>
                                        <input type="checkbox" id="transactions" name="access_scope"
                                            value="transactions">
                                        <label for="transactions" class="form-label">Account transactions</label>
                                    </div>
                                </div>
                            </fieldset>
                            <input type="text" id="bank" name="bank" hidden>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-between">
        <a id="cancel-btn" href="{{ url_for('account.advanced') }}" class="btn btn-danger">
            <i class="fas fa-arrow-left me-1"></i>Cancel
        </a>
        <button id="back-btn" class="btn btn-secondary d-none" onclick="goToStage('choose-country')">
            <i class="fas fa-arrow-left me-1"></i>Back
        </button>
        <button id="next-step-btn" class="btn btn-primary" disabled onclick="goToStage('choose-bank')">
            <i class="fas fa-arrow-right me-1"></i>Next step
        </button>
        <button type="submit" id="submit-btn" class="btn btn-primary d-none" form="agreement-terms">
            <i class="fas fa-checkmark me-1"></i>Submit
        </button>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    var currentStage = "";

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById("next-step-btn").disabled = true;
        currentStage = "choose-country";
    })

    function populateBankSelect(country) {
        let sortedBanks = JSON.parse(`{{ (banks | tojson) }}`);
        const countryBanks = sortedBanks[country];
        const select = document.getElementById("bank-select")
        select.replaceChildren();

        for (i = 0; i < countryBanks.length; i++) {
            let bank = document.createElement("div");
            bank.classList.add("d-flex", "justify-content-center", "bank");
            bank.appendChild(document.createTextNode(countryBanks[i]["name"]));
            bank.setAttribute("id", countryBanks[i]["id"]);
            bank.setAttribute("onclick", 'selectBank(this)');
            select.appendChild(bank);
            if (i < countryBanks.length - 1) {
                let dividerDiv = document.createElement("div");
                dividerDiv.classList.add("d-flex", "justify-content-center");
                let divider = document.createElement("div");
                divider.classList.add("divider")
                dividerDiv.appendChild(divider);
                select.appendChild(dividerDiv);
            }
        }
    }

    function selectCountry(el) {
        document.querySelectorAll('.country').forEach(item => item.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById("next-step-btn").disabled = false;
        populateBankSelect(el.getAttribute("data-code"));
    }

    function selectBank(bank) {
        document.querySelectorAll(".bank").forEach(item => item.classList.remove('bank-selected'));
        bank.classList.add('bank-selected');
        document.getElementById("bank_value").value = bank.innerHTML;
        document.getElementById("bank").value = bank.getAttribute("id");
    }

    function goToStage(stage) {
        const src = document.getElementsByClassName("tab-pane fade show active")[0];
        const dest = document.getElementById(stage);

        const back = document.getElementById("back-btn");
        const cancel = document.getElementById("cancel-btn");
        const nextstep = document.getElementById("next-step-btn");
        const submit = document.getElementById("submit-btn");

        if (stage == "choose-country") {
            nextstep.setAttribute("onclick", "goToStage('choose-bank')");
        } else if (stage == "choose-bank") {
            back.setAttribute("onclick", "goToStage('choose-country')");
            nextstep.setAttribute("onclick", "goToStage('choose-terms')");
        } else if (stage == "choose-terms") {
            back.setAttribute("onclick", "goToStage('choose-bank')");
        }

        if (src == dest) return;

        requestAnimationFrame(() => {
            src.classList.remove("show")

            setTimeout(() => {
                src.classList.remove("active");
                dest.classList.add("active");
                void dest.offsetWidth;
                dest.classList.add("show");

                if (stage == "choose-country") {
                    back.classList.add("d-none");
                    cancel.classList.remove("d-none");
                    nextstep.classList.remove("d-none");
                } else if (stage == "choose-bank") {
                    back.classList.remove("d-none");
                    cancel.classList.add("d-none");
                    nextstep.classList.remove("d-none");
                    document.getElementById("bank-select").scrollTop = 0;
                    submit.classList.add("d-none");
                } else if (stage == "choose-terms") {
                    nextstep.classList.add("d-none");
                    submit.classList.remove("d-none");
                } else {

                }
            }, 300);
        });
    }
</script>
{% endblock %}